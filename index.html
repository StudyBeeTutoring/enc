<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <!-- Load Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        /* --- DARK OPS THEME --- */
        body { font-family: 'Courier New', monospace; background-color: #050505; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #ccc; }
        .container { width: 380px; background: #111; border-radius: 4px; border: 1px solid #333; box-shadow: 0 0 40px rgba(0,0,0,1); padding: 20px; position: relative; }
        
        /* Scanline Effect */
        .container::before { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none; opacity: 0.3;}

        .app-view { display: none; }
        .app-view.active { display: block; }

        /* Calculator (Disguise) */
        .display { background: #222; color: #fff; text-align: right; padding: 25px; font-size: 2.2em; border-radius: 2px; margin-bottom: 20px; font-family: sans-serif; overflow-x: auto;}
        .buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .btn { background: #1a1a1a; color: #ddd; border: 1px solid #333; padding: 20px; font-size: 1.2em; cursor: pointer; transition: 0.1s; }
        .btn:hover { background: #2a2a2a; border-color: #555; }
        .equal { background: #b71c1c; color: white; border-color: #b71c1c; }
        
        /* Secure Interface */
        h2 { text-align: center; color: #b71c1c; letter-spacing: 4px; font-size: 1em; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top:0; text-transform: uppercase;}
        
        .tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .tab-link { background: transparent; border: none; flex: 1; padding: 10px; color: #555; cursor: pointer; font-family: inherit; font-weight: bold; }
        .tab-link.active { color: #b71c1c; border-bottom: 2px solid #b71c1c; background: #111; }
        .tab-content { display: none; }

        label { font-size: 0.7em; color: #666; display: block; margin-bottom: 5px; text-transform: uppercase; }
        input, textarea, select { width: 100%; background: #000; border: 1px solid #333; color: #0f0; padding: 10px; box-sizing: border-box; margin-bottom: 15px; font-family: monospace; outline: none; }
        input:focus, textarea:focus { border-color: #b71c1c; }
        textarea { min-height: 80px; resize: vertical; }

        /* Output Options */
        .mode-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-opt { flex: 1; background: #222; padding: 10px; text-align: center; cursor: pointer; border: 1px solid #333; font-size: 0.8em; }
        .mode-opt.active { background: #b71c1c; color: white; border-color: #b71c1c; }

        .action-btn { width: 100%; background: #b71c1c; color: white; border: none; padding: 15px; cursor: pointer; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; margin-top: 10px; }
        .action-btn:hover { background: #d32f2f; }
        .action-btn:disabled { background: #333; cursor: not-allowed; color: #555; }

        #status-message { color: #ff9800; text-align: center; font-size: 0.8em; margin-top: 10px; min-height: 20px; white-space: pre-wrap; }
        .copy-box { background: #151515; padding: 10px; border: 1px solid #333; word-break: break-all; font-size: 0.8em; color: #888; display: none; cursor: pointer; }
        .copy-box:hover { color: #fff; border-color: #555; }

        /* Overlay for Lockout */
        #lockout { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 1000; text-align: center; padding-top: 50%; color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <!-- CALCULATOR VIEW -->
        <div id="calculator" class="app-view active">
            <div class="display" id="calc-display">0</div>
            <div class="buttons">
                <button class="btn" onclick="calcInput('C')">AC</button>
                <button class="btn" onclick="calcInput('/')">÷</button>
                <button class="btn" onclick="calcInput('*')">×</button>
                <button class="btn" onclick="calcInput('del')">⌫</button>
                <button class="btn" onclick="calcInput('7')">7</button>
                <button class="btn" onclick="calcInput('8')">8</button>
                <button class="btn" onclick="calcInput('9')">9</button>
                <button class="btn" onclick="calcInput('-')">-</button>
                <button class="btn" onclick="calcInput('4')">4</button>
                <button class="btn" onclick="calcInput('5')">5</button>
                <button class="btn" onclick="calcInput('6')">6</button>
                <button class="btn" onclick="calcInput('+')">+</button>
                <button class="btn" onclick="calcInput('1')">1</button>
                <button class="btn" onclick="calcInput('2')">2</button>
                <button class="btn" onclick="calcInput('3')">3</button>
                <button class="btn equal" onclick="calcInput('=')">=</button>
                <button class="btn" style="grid-column: span 2" onclick="calcInput('0')">0</button>
                <button class="btn" onclick="calcInput('.')">.</button>
            </div>
        </div>

        <!-- ENCRYPTOR VIEW -->
        <div id="encryptor" class="app-view">
            <button onclick="lockAndExit()" style="float:right; background:none; border:none; color:#555; cursor:pointer;">[EXIT]</button>
            <h2>Paranoid Protocol</h2>
            
            <div class="tabs">
                <button class="tab-link active" onclick="switchTab('Encrypt')">ENCRYPT</button>
                <button class="tab-link" onclick="switchTab('Decrypt')">DECRYPT</button>
            </div>

            <!-- ENCRYPT -->
            <div id="Encrypt" class="tab-content" style="display:block;">
                
                <div class="mode-switch">
                    <div id="mode-text" class="mode-opt active" onclick="setMode('text')">TEXT / LINK</div>
                    <div id="mode-img" class="mode-opt" onclick="setMode('img')">IMAGE HIDE</div>
                </div>

                <textarea id="msg-input" placeholder=">> ENTER CLASSIFIED INTEL"></textarea>
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:2">
                        <input type="password" id="enc-pass" placeholder=">> PASSPHRASE">
                    </div>
                    <div style="flex:1">
                        <input type="number" id="enc-timer" placeholder="MINS" title="Self-Destruct Timer (0 = Never)">
                    </div>
                </div>

                <div id="file-input-area" style="display:none;">
                    <label>CARRIER IMAGE (PNG)</label>
                    <input type="file" id="enc-file" accept="image/png">
                </div>

                <button id="btn-enc" class="action-btn" onclick="processEncrypt()">EXECUTE</button>
                
                <!-- Output for Text Mode -->
                <div id="text-output" class="copy-box" onclick="copyToClip(this.innerText)"></div>
            </div>

            <!-- DECRYPT -->
            <div id="Decrypt" class="tab-content">
                <input type="password" id="dec-pass" placeholder=">> PASSPHRASE">
                
                <div id="dec-mode-selector" style="margin-bottom:15px; font-size:0.8em; color:#666;">
                    INPUT SOURCE: 
                    <label style="display:inline; margin-left:10px;"><input type="radio" name="d-src" value="text" checked onclick="toggleDecInput()"> TEXT/LINK</label>
                    <label style="display:inline; margin-left:10px;"><input type="radio" name="d-src" value="img" onclick="toggleDecInput()"> IMAGE</label>
                </div>

                <div id="dec-text-area">
                    <textarea id="dec-text-input" placeholder=">> PASTE ENCRYPTED PAYLOAD"></textarea>
                </div>

                <div id="dec-file-area" style="display:none;">
                    <input type="file" id="dec-file" accept="image/png">
                </div>

                <button id="btn-dec" class="action-btn" onclick="processDecrypt()">DECRYPT</button>
                
                <div id="dec-result" style="margin-top:15px; color:#0f0; border:1px dashed #333; padding:10px; display:none; overflow-wrap: break-word;"></div>
            </div>

            <div id="status-message">Initializing Crypto Core...</div>
        </div>

        <div id="lockout">DATA EXPIRED<br>DELETED</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SECRET_PIN = "999999"; 
        let pyodide = null;
        let isPyReady = false;
        let currentMode = 'text'; // 'text' or 'img'

        // --- CALCULATOR LOGIC ---
        let calcExpr = "";
        const calcDisp = document.getElementById('calc-display');

        function calcInput(val) {
            if (val === 'C') { calcExpr = ""; calcDisp.innerText = "0"; }
            else if (val === 'del') { calcExpr = calcExpr.slice(0, -1); calcDisp.innerText = calcExpr || "0"; }
            else if (val === '=') {
                if (calcExpr === SECRET_PIN) { unlockApp(); return; }
                try { calcDisp.innerText = eval(calcExpr) || "0"; calcExpr = String(eval(calcExpr)); } 
                catch { calcDisp.innerText = "Err"; calcExpr = ""; }
            } else {
                if(calcExpr.length < 15) {
                    calcExpr += val;
                    calcDisp.innerText = calcExpr;
                }
            }
        }

        function unlockApp() {
            document.getElementById('calculator').classList.remove('active');
            document.getElementById('encryptor').classList.add('active');
            initPython();
            checkUrlHash(); // Check for incoming share links
        }

        function lockAndExit() {
            location.hash = ""; // Clear URL
            location.reload(); // Hard reset
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).style.display = 'block';
            event.target.classList.add('active');
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('mode-text').className = mode === 'text' ? 'mode-opt active' : 'mode-opt';
            document.getElementById('mode-img').className = mode === 'img' ? 'mode-opt active' : 'mode-opt';
            document.getElementById('file-input-area').style.display = mode === 'img' ? 'block' : 'none';
            document.getElementById('text-output').style.display = 'none';
        }

        function toggleDecInput() {
            const isImg = document.querySelector('input[name="d-src"]:checked').value === 'img';
            document.getElementById('dec-text-area').style.display = isImg ? 'none' : 'block';
            document.getElementById('dec-file-area').style.display = isImg ? 'block' : 'none';
        }

        function status(msg) { document.getElementById('status-message').innerText = msg; }

        function copyToClip(text) {
            navigator.clipboard.writeText(text);
            status("COPIED TO CLIPBOARD");
        }

        // --- URL LINK HANDLING ---
        function checkUrlHash() {
            if(window.location.hash.length > 10) {
                // We have a payload
                const payload = window.location.hash.substring(1); // Remove #
                switchTab('Decrypt');
                document.getElementById('dec-text-input').value = payload;
                status("INCOMING TRANSMISSION DETECTED");
            }
        }

        function generateLink(payload) {
            const baseUrl = window.location.href.split('#')[0];
            return `${baseUrl}#${payload}`;
        }

        // --- PYODIDE & ENCRYPTION CORE ---
        async function initPython() {
            if (isPyReady) return;
            status("LOADING MILITARY GRADE MODULES...");
            
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");
                await micropip.install("cryptography");
                await micropip.install("Pillow"); // Image manipulation

                await pyodide.runPythonAsync(`
import os
import json
import base64
import time
import io
from cryptography.hazmat.primitives.ciphers.aead import AESGCM, ChaCha20Poly1305
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from cryptography.hazmat.primitives import hashes
from PIL import Image

class ParanoidEncryptor:
    def __init__(self):
        # 600,000 Iterations for Extreme Bruteforce Resistance
        self.iterations = 600000 
        self.salt_len = 32

    def _derive_keys(self, password, salt):
        # Derive 64 bytes (32 for AES, 32 for ChaCha)
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=64, 
            salt=salt,
            iterations=self.iterations,
        )
        key_material = kdf.derive(password.encode())
        return key_material[:32], key_material[32:]

    def encrypt(self, plaintext, password, expiry_minutes):
        # 1. Prepare Payload with Expiration
        expiration_ts = 0
        if expiry_minutes > 0:
            expiration_ts = int(time.time()) + (expiry_minutes * 60)
            
        data = json.dumps({"msg": plaintext, "exp": expiration_ts}).encode('utf-8')

        # 2. Key Derivation
        salt = os.urandom(self.salt_len)
        aes_key, chacha_key = self._derive_keys(password, salt)

        # 3. Layer 1: AES-256-GCM
        aes_nonce = os.urandom(12)
        aes = AESGCM(aes_key)
        layer1 = aes.encrypt(aes_nonce, data, None)

        # 4. Layer 2: ChaCha20-Poly1305 (Cascade)
        chacha_nonce = os.urandom(12)
        chacha = ChaCha20Poly1305(chacha_key)
        layer2 = chacha.encrypt(chacha_nonce, layer1, None)

        # 5. Pack: Salt(32) + AES_Nonce(12) + ChaCha_Nonce(12) + Ciphertext
        final_bytes = salt + aes_nonce + chacha_nonce + layer2
        return base64.urlsafe_b64encode(final_bytes).decode('utf-8')

    def decrypt(self, b64_data, password):
        try:
            raw_data = base64.urlsafe_b64decode(b64_data)
            
            # Extract Components
            salt = raw_data[:32]
            aes_nonce = raw_data[32:44]
            chacha_nonce = raw_data[44:56]
            ciphertext = raw_data[56:]

            # Derive Keys
            aes_key, chacha_key = self._derive_keys(password, salt)

            # Layer 2 Decrypt (ChaCha)
            chacha = ChaCha20Poly1305(chacha_key)
            layer1 = chacha.decrypt(chacha_nonce, ciphertext, None)

            # Layer 1 Decrypt (AES)
            aes = AESGCM(aes_key)
            json_bytes = aes.decrypt(aes_nonce, layer1, None)

            # Parse JSON & Check Expiry
            payload = json.loads(json_bytes.decode('utf-8'))
            
            if payload['exp'] > 0 and int(time.time()) > payload['exp']:
                return "EXPIRED"
            
            return payload['msg']

        except Exception as e:
            return "ERROR"

    def hide_in_image(self, img_bytes, b64_payload):
        # Convert B64 string to bytes
        payload_bytes = b64_payload.encode('utf-8')
        length = len(payload_bytes)
        
        img = Image.open(io.BytesIO(img_bytes)).convert('RGB')
        pixels = list(img.getdata())
        
        # 32-bit length header + payload
        full_data = length.to_bytes(4, 'big') + payload_bytes
        
        bits = []
        for byte in full_data:
            for i in range(8):
                bits.append((byte >> (7-i)) & 1)
                
        if len(bits) > len(pixels) * 3:
            return "SIZE_ERR"
            
        new_pixels = []
        idx = 0
        for p in pixels:
            if idx < len(bits):
                r = (p[0] & ~1) | bits[idx]; idx += 1
            else: r = p[0]
            if idx < len(bits):
                g = (p[1] & ~1) | bits[idx]; idx += 1
            else: g = p[1]
            if idx < len(bits):
                b = (p[2] & ~1) | bits[idx]; idx += 1
            else: b = p[2]
            new_pixels.append((r,g,b))
            
        img.putdata(new_pixels)
        out = io.BytesIO()
        img.save(out, format='PNG')
        return out.getvalue()

    def reveal_from_image(self, img_bytes):
        img = Image.open(io.BytesIO(img_bytes)).convert('RGB')
        pixels = list(img.getdata())
        
        bits = []
        for p in pixels:
            bits.extend([p[0]&1, p[1]&1, p[2]&1])
            
        # Reconstruct Length (first 32 bits)
        len_val = 0
        for i in range(32):
            len_val = (len_val << 1) | bits[i]
            
        # Bounds check
        if len_val <= 0 or len_val > len(pixels): return None
        
        # Reconstruct Payload
        payload_bytes = bytearray()
        for i in range(len_val):
            val = 0
            for b in range(8):
                bit_index = 32 + (i*8) + b
                val = (val << 1) | bits[bit_index]
            payload_bytes.append(val)
            
        return payload_bytes.decode('utf-8')

engine = ParanoidEncryptor()
                `);
                isPyReady = true;
                status("SYSTEM READY. CASCADE ENCRYPTION ACTIVE.");
            } catch(e) {
                status("INIT FAILURE: " + e);
            }
        }

        // --- HANDLERS ---
        async function processEncrypt() {
            if (!isPyReady) return;
            const msg = document.getElementById('msg-input').value;
            const pass = document.getElementById('enc-pass').value;
            const mins = document.getElementById('enc-timer').value || 0;
            const btn = document.getElementById('btn-enc');
            
            if(!msg || !pass) { status("MISSING DATA"); return; }
            
            btn.disabled = true;
            status("ENCRYPTING (600k ITERATIONS)...");

            // Python Bridge
            pyodide.globals.set("js_msg", msg);
            pyodide.globals.set("js_pass", pass);
            pyodide.globals.set("js_mins", parseInt(mins));

            try {
                // Step 1: Generate Encrypted Base64 String
                let b64_result = await pyodide.runPythonAsync(`engine.encrypt(js_msg, js_pass, js_mins)`);

                if (currentMode === 'text') {
                    // Show Link & Text
                    const link = generateLink(b64_result);
                    const displayHTML = `<b>ENCRYPTED PAYLOAD:</b><br>${b64_result.substring(0,30)}...<br><br><b>SHARE LINK:</b><br>${link}`;
                    
                    const outBox = document.getElementById('text-output');
                    outBox.innerHTML = displayHTML;
                    outBox.style.display = 'block';
                    outBox.onclick = function() { copyToClip(link); };
                    status("ENCRYPTION COMPLETE. CLICK BOX TO COPY LINK.");

                } else {
                    // Image Steganography
                    const fileInput = document.getElementById('enc-file');
                    if (!fileInput.files[0]) throw new Error("NO IMAGE SELECTED");
                    
                    const buff = await fileInput.files[0].arrayBuffer();
                    pyodide.globals.set("js_img", new Uint8Array(buff));
                    pyodide.globals.set("js_payload", b64_result);

                    const img_bytes = await pyodide.runPythonAsync(`engine.hide_in_image(js_img.to_py(), js_payload)`);
                    
                    if (img_bytes === "SIZE_ERR") throw new Error("MSG TOO LARGE FOR IMAGE");

                    const blob = new Blob([img_bytes.toJs()], {type: 'image/png'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'confidential.png';
                    a.click();
                    status("IMAGE DOWNLOADED");
                }
            } catch(e) {
                status("ERROR: " + e.message);
            } finally {
                btn.disabled = false;
                pyodide.runPython("del js_msg, js_pass"); // Cleanup
            }
        }

        async function processDecrypt() {
            if (!isPyReady) return;
            const pass = document.getElementById('dec-pass').value;
            const resBox = document.getElementById('dec-result');
            const btn = document.getElementById('btn-dec');
            
            if(!pass) { status("PASSWORD REQUIRED"); return; }
            btn.disabled = true;
            status("DECRYPTING...");

            try {
                let payload = "";
                
                // Get Payload Source
                if (document.querySelector('input[name="d-src"]:checked').value === 'text') {
                    payload = document.getElementById('dec-text-input').value.trim();
                } else {
                    const fileInput = document.getElementById('dec-file');
                    if(!fileInput.files[0]) throw new Error("NO FILE");
                    const buff = await fileInput.files[0].arrayBuffer();
                    pyodide.globals.set("js_dec_img", new Uint8Array(buff));
                    payload = await pyodide.runPythonAsync(`engine.reveal_from_image(js_dec_img.to_py())`);
                    if(!payload) throw new Error("NO HIDDEN DATA");
                }

                // Decrypt Payload
                pyodide.globals.set("js_b64", payload);
                pyodide.globals.set("js_dec_pass", pass);
                
                const result = await pyodide.runPythonAsync(`engine.decrypt(js_b64, js_dec_pass)`);

                if (result === "EXPIRED") {
                    document.getElementById('lockout').style.display = 'block'; // Trigger Scary Overlay
                    status("MSG DESTROYED");
                } else if (result === "ERROR") {
                    status("DECRYPTION FAILED (WRONG PASSWORD?)");
                } else {
                    resBox.style.display = 'block';
                    resBox.innerText = result;
                    status("SUCCESSFULLY DECRYPTED");
                }

            } catch(e) {
                status("ERROR: " + e.message);
            } finally {
                btn.disabled = false;
            }
        }

    </script>
</body>
</html>
